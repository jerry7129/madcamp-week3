version: '3.8'

services:
  # 1. 백엔드 서버
  backend:
    build: .
    ports:
      - "80:8000"
    depends_on:
      - db
      - gpt-sovits
    restart: always
    volumes:
      - ./temp_shared:/shared
    environment:
      - GPT_SOVITS_URL=http://gpt-sovits:9800
      - SHARED_DIR=/shared # 백엔드가 파일 저장할 경로

  # 2. MySQL 데이터베이스
  db:
    image: mysql:8.0
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: gptsovits_db
    # DB 포트(3306)는 외부에서 접근 못해도 괜찮습니다.
    # 백엔드(backend)와 DB(db)는 같은 도커 네트워크 안에 있어서
    # 방화벽과 상관없이 서로 대화할 수 있습니다.
    expose:
      - "3306"
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci

  # 3. GPT-SoVITS (AI 엔진)
  gpt-sovits:
    image: gpt-sovits-custom # 이미지 이름 지정
    shm_size: 16G         # [중요] AI 모델은 공유 메모리가 많이 필요함
    ports:
      - "9880:9880"       # 내부 API 통신용
      - "9874:9874"       # (선택) 필요시 WebUI용 포트도 열어둠
    volumes:
      # [핵심] Conda에서 쓰던 폴더를 도커 내부 /workspace로 연결
      - ../GPT-SoVITS:/workspace
      - ./temp_shared:/shared
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia  # GPU 사용 설정 (필수)
              count: 1
              capabilities: [gpu]
    # 도커가 켜질 때 실행할 명령어 (API 서버 실행)
    command: python api_v2.py -a 0.0.0.0 -p 9880