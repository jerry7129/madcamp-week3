version: '3.8'

services:
  # 1. 백엔드 서버
  backend:
    build: .
    ports:
      - "80:8000"
    depends_on:
      - db
      - gpt-sovits
    restart: always
    volumes:
      - ./temp_shared:/shared
      - ./static:/backend/static
    environment:
      - GPT_SOVITS_URL=http://gpt-sovits:9880
      - SHARED_DIR=/shared # 백엔드가 파일 저장할 경로

  # 2. MySQL 데이터베이스
  db:
    image: mysql:8.0
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: gptsovits_db
    # DB 포트(3306)는 외부에서 접근 못해도 괜찮습니다.
    # 백엔드(backend)와 DB(db)는 같은 도커 네트워크 안에 있어서
    # 방화벽과 상관없이 서로 대화할 수 있습니다.
    expose:
      - "3306"
    volumes:
      - ./mysql_data:/var/lib/mysql
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci

  # 3. GPT-SoVITS (AI 엔진)
  gpt-sovits:
    image: gpt-sovits-custom # 이미지 이름 지정
    shm_size: 16G         # [중요] AI 모델은 공유 메모리가 많이 필요함
    ports:
      - "9880:9880"       # 내부 API 통신용
      - "9874:9874"       # (선택) 필요시 WebUI용 포트도 열어둠
      - "9871:9871"       # [NEW] WebUI 하위 도구(Audio Slicer 등)용 포트
      - "9872:9872"
    volumes:
      # [핵심] Conda에서 쓰던 폴더를 도커 내부 /workspace로 연결
      - ../GPT-SoVITS:/workspace
      - ../checkpoint:/workspace/logs # [NEW] 체크포인트 저장소
      - ./temp_shared:/shared
      - ./ai_server.py:/workspace/ai_server.py # [NEW] 래퍼 스크립트 마운트
      - ../voice_dataset:/workspace/voice_dataset # [NEW] 데이터셋 마운트
      - ../hf_cache:/root/.cache/huggingface # [NEW] 모델 다운로드 캐시 저장
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia  # GPU 사용 설정 (필수)
              count: 1
              capabilities: [gpu]
    # 도커가 켜질 때 실행할 명령어 (패키지 설치 후 API 실행)
    command: >
      sh -c "pip install faster_whisper && python ai_server.py"